rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is accessing their own document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to fetch user role
    // CAUTION: This costs one read operation per rule check. 
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return getUserRole() == 'admin';
    }

    // Users collection
    // Read: Authenticated users can read profiles (needed for team lists)
    // Write: ONLY the user themselves or an Admin
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin(); 
    }

    // Logs collection
    match /logs/{logId} {
      allow read: if isAuthenticated();
      // Create: Authenticated users can create logs ONLY for themselves
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      // Update: Only the creator or Admin can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid || 
        isAdmin()
      );
      // Delete: CRITICAL FIX - Only creator or Admin can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid || 
        isAdmin()
      );
    }

    // Teams collection
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                   (request.resource.data.leaderId == request.auth.uid || isAdmin());
      
      allow update: if isAuthenticated() && (
        resource.data.leaderId == request.auth.uid || 
        isAdmin() ||
        (
             // Allow updating array fields (joining members) check would be complex here, 
             // relying on application logic for now but ensuring critical fields don't change without permission
             request.resource.data.leaderId == resource.data.leaderId && 
             request.resource.data.name == resource.data.name
        )
      );
      
      allow delete: if isAuthenticated() && 
                   (resource.data.leaderId == request.auth.uid || isAdmin());
    }

    // Invitations collection
    match /invitations/{invitationId} {
      allow read: if isAuthenticated();
      
      // Create: Any auth user can request to join (create an invitation)
      allow create: if isAuthenticated() && request.resource.data.invitedBy == request.auth.uid;
      
      // Update: ONLY Team Leader or Admin can update (e.g. approve)
      // This prevents a user from approving their own request.
      allow update: if isAuthenticated() && (
        isAdmin() ||
        get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.leaderId == request.auth.uid
      );
      
      // Delete: Leader (reject), Admin, or the User themselves (cancel request)
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.invitedBy == request.auth.uid ||
        get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.leaderId == request.auth.uid
      ); 
    }

    // Milestones collection
    match /milestones/{milestoneId} {
      allow read: if isAuthenticated();
      
      // Create: Only Team Leader or Admin
      allow create: if isAuthenticated() && (
        isAdmin() ||
        get(/databases/$(database)/documents/teams/$(request.resource.data.teamId)).data.leaderId == request.auth.uid
      );

      // Update/Delete: Only Team Leader or Admin
      allow update, delete: if isAuthenticated() && (
        isAdmin() ||
        get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.leaderId == request.auth.uid
      );
    }
  }
}
